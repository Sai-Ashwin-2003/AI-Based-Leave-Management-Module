{% extends "myapp/manager_base.html" %}
{% block content %}

<h2 class="text-2xl font-semibold text-gray-800 mb-6">Leave Request Details</h2>

<div class="bg-white shadow-md rounded-lg p-6 mb-6">
  <h3 class="text-xl font-semibold mb-4">Employee Info</h3>
  <p><strong>Name:</strong> {{ leave.user.username }}</p>
  <p><strong>Designation:</strong> {{ leave.user.designation|default:"Not Set" }}</p>
  <p><strong>Manager:</strong>
      {% if leave.user.manager %}
        {{ leave.user.manager.username }}
      {% elif projects %}
        {{ projects.0.project.lead.username }}
      {% else %}
        None
      {% endif %}
  </p>
</div>

<div class="bg-white shadow-md rounded-lg p-6 mb-6">
  <h3 class="text-xl font-semibold mb-4">Leave Request</h3>
  <p><strong>Type:</strong> {{ leave.leave_type.name }}</p>
  <p><strong>Dates:</strong> {{ leave.start_date }} â†’ {{ leave.end_date }}</p>
  <p><strong>Reason:</strong> {{ leave.reason }}</p>
  <p><strong>Status:</strong> {{ leave.status }}</p>
</div>

<div class="bg-white shadow-md rounded-lg p-6 mb-6">
  <h3 class="text-xl font-semibold mb-4">Projects</h3>
  {% if projects %}
    <table class="min-w-full bg-white rounded-lg shadow">
      <thead class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
        <tr>
          <th class="px-6 py-3 border-b">Project</th>
          <th class="px-6 py-3 border-b">Lead</th>
          <th class="px-6 py-3 border-b">Status</th>
          <th class="px-6 py-3 border-b">Role</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for member in projects %}
        <tr>
          <td class="px-6 py-4">{{ member.project.name }}</td>
          <td class="px-6 py-4">{{ member.project.lead.username|default:"-" }}</td>
          <td class="px-6 py-4">{{ member.project.status }}</td>
          <td class="px-6 py-4">{{ member.role_in_project|default:"Member" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button id="notify-btn" data-leave-id="{{ leave.id }}" class="mt-4 px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Notify Team Leads</button>
  {% else %}
    <p class="text-gray-500">No projects assigned.</p>
  {% endif %}
</div>

<div class="bg-white shadow-md rounded-lg p-6 mb-6">
  <h3 class="text-xl font-semibold mb-4">Leave Balances</h3>
  {% if balances %}
    <ul class="list-disc pl-5">
      {% for bal in balances %}
        <li>{{ bal.leave_type.name }}: {{ bal.remaining }} days remaining</li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-gray-500">No leave balances available.</p>
  {% endif %}
</div>

<div class="bg-white shadow-md rounded-lg p-6 mb-6">
  <h3 class="text-xl font-semibold mb-4">AI Suggestions</h3>
  <div class="text-gray-700 whitespace-pre-line leading-relaxed">
    {{ ai_suggestions }}
  </div>
</div>

<div class="flex gap-4 mb-6">
  <a href="{% url 'manager_approve_leave' leave.id %}" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Approve</a>
  <a href="{% url 'manager_reject_leave' leave.id %}" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reject</a>
</div>

<script>
const notifyBtn = document.getElementById("notify-btn");
if (notifyBtn) {
    notifyBtn.addEventListener("click", () => {
        const leaveId = notifyBtn.dataset.leaveId;
        fetch(`/leave/${leaveId}/notify/`)
          .then(res => res.json())
          .then(data => alert(data.message))
          .catch(err => console.error(err));
    });
}
</script>

{% endblock %}
