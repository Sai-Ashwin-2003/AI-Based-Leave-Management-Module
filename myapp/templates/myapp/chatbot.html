<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chatbot</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Custom resize handle */
  #resize-handle {
    width: 15px;
    height: 15px;
    cursor: se-resize;
    position: absolute;
    right: 0;
    bottom: 0;
  }
</style>
</head>
<body class="relative">

<!-- Chat Toggle Button -->
<button id="chat-toggle" class="fixed bottom-6 right-6 z-50 bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none">ðŸ’¬</button>

<!-- Chat Window -->
<div id="chat-window" class="fixed bottom-6 right-6 z-40 hidden">
<div id="chat-container" class="fixed bottom-6 right-6 z-[9999] bg-white shadow-lg flex flex-col rounded-lg overflow-hidden"
     style="width: 320px; height: 400px; min-width: 250px; min-height: 300px; max-width: 50vw; max-height: 90vh;">

    <!-- Header -->
    <div id="chat-header" class="bg-indigo-600 text-white p-3 flex justify-between items-center cursor-move select-none rounded-t-lg">
      AI Assistant
      <button id="chat-close" class="text-white text-lg">âœ–</button>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="flex-1 p-3 overflow-y-auto text-sm space-y-2 text-gray-800"></div>

    <!-- Input -->
    <div class="flex border-t p-2">
      <input id="chat-input" type="text" placeholder="Ask me anything..." class="flex-1 border rounded-l p-2 text-sm focus:outline-none" />
      <button id="chat-send" class="bg-indigo-600 text-white px-3 rounded-r hover:bg-indigo-700">âž¤</button>
    </div>

    <!-- Resize Handle -->
    <div id="resize-handle"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const chatToggle = document.getElementById("chat-toggle");
  const chatWindow = document.getElementById("chat-window");
  const chatClose = document.getElementById("chat-close");
  const chatSend = document.getElementById("chat-send");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");
  const chatContainer = document.getElementById("chat-container");
  const resizeHandle = document.getElementById("resize-handle");
  const chatHeader = document.getElementById("chat-header");

  // Toggle chat visibility
  chatToggle.onclick = () => chatWindow.classList.toggle("hidden");
  chatClose.onclick = () => chatWindow.classList.add("hidden");

  // Send message
  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    const userMessage = document.createElement("div");
    userMessage.className = "text-right text-sm text-gray-800";
    userMessage.textContent = message;
    chatMessages.appendChild(userMessage);

    chatInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    const role = "{{ user.role }}"; // Django template
    const response = await fetch("{% url 'chat' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ message, role })
    });

    const data = await response.json();
    const botMessage = document.createElement("div");
    botMessage.className = "text-left text-sm text-indigo-700";
    botMessage.textContent = data.response;
    chatMessages.appendChild(botMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  chatSend.onclick = sendMessage;
  chatInput.addEventListener("keypress", e => e.key === "Enter" && sendMessage());

  // Resizing
  let isResizing = false;
  resizeHandle.addEventListener("mousedown", e => isResizing = true);
  document.addEventListener("mousemove", e => {
    if (!isResizing) return;
    let newWidth = e.clientX - chatContainer.getBoundingClientRect().left;
    let newHeight = e.clientY - chatContainer.getBoundingClientRect().top;
    if(newWidth > 250 && newWidth < window.innerWidth/2) chatContainer.style.width = newWidth + "px";
    if(newHeight > 300 && newHeight < window.innerHeight*0.9) chatContainer.style.height = newHeight + "px";
  });
  document.addEventListener("mouseup", () => isResizing = false);

  // Dragging
  let isDragging = false, offsetX = 0, offsetY = 0;
  chatHeader.addEventListener("mousedown", e => {
    isDragging = true;
    const rect = chatContainer.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
  });
    document.addEventListener("mousemove", e => {
      if (!isDragging) return;
      chatContainer.style.position = "fixed"; // make sure
      chatContainer.style.left = (e.clientX - offsetX) + "px";
      chatContainer.style.top = (e.clientY - offsetY) + "px";
      chatContainer.style.right = "auto";
      chatContainer.style.bottom = "auto";
    });
  document.addEventListener("mouseup", () => isDragging = false);
});
</script>

</body>
</html>
