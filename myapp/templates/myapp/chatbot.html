<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chatbot</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  #resize-handle {
    width: 15px;
    height: 15px;
    cursor: se-resize;
    position: absolute;
    right: 0;
    bottom: 0;
  }
  .ai-container {
    animation: fadeIn 0.4s ease-in-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .ai-message ul { margin-left: 1.25rem; }
  .status {
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .status.Approved { background-color: #dcfce7; color: #166534; }
  .status.Pending { background-color: #fef9c3; color: #854d0e; }
  .status.Rejected { background-color: #fee2e2; color: #991b1b; }
</style>
</head>
<body class="relative bg-gray-50">

<!-- Chat Toggle -->
<button id="chat-toggle" class="fixed bottom-6 right-6 z-50 bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none">ðŸ’¬</button>

<!-- Chat Window -->
<div id="chat-window" class="fixed bottom-6 right-6 z-40 hidden">
  <div id="chat-container" class="fixed bottom-6 right-6 z-[9999] bg-white shadow-lg flex flex-col rounded-lg overflow-hidden"
       style="width: 340px; height: 450px; min-width: 250px; min-height: 320px; max-width: 50vw; max-height: 90vh;">

    <!-- Header -->
    <div id="chat-header" class="bg-indigo-600 text-white p-3 flex justify-between items-center cursor-move select-none rounded-t-lg">
      AI Assistant
      <button id="chat-close" class="text-white text-lg">âœ–</button>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="flex-1 p-3 overflow-y-auto text-sm space-y-2 text-gray-800 bg-gray-50"></div>

    <!-- Input -->
    <div class="flex border-t p-2 bg-white">
      <input id="chat-input" type="text" placeholder="Ask me anything..." class="flex-1 border rounded-l p-2 text-sm focus:outline-none" />
      <button id="chat-send" class="bg-indigo-600 text-white px-3 rounded-r hover:bg-indigo-700">âž¤</button>
    </div>

    <div id="resize-handle"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const chatToggle = document.getElementById("chat-toggle");
  const chatWindow = document.getElementById("chat-window");
  const chatClose = document.getElementById("chat-close");
  const chatSend = document.getElementById("chat-send");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");
  const chatContainer = document.getElementById("chat-container");
  const resizeHandle = document.getElementById("resize-handle");
  const chatHeader = document.getElementById("chat-header");

  chatToggle.onclick = () => chatWindow.classList.toggle("hidden");
  chatClose.onclick = () => chatWindow.classList.add("hidden");

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    const userMsg = document.createElement("div");
    userMsg.className = "text-right bg-indigo-100 text-indigo-800 px-3 py-2 rounded-xl ml-auto max-w-[80%]";
    userMsg.textContent = message;
    chatMessages.appendChild(userMsg);
    chatInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    const role = "{{ user.role }}";

    const response = await fetch("{% url 'chat' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ message, role })
    });

    const data = await response.json();
    renderAIResponse(data.response);
  }

  function renderAIResponse(responseHtml) {
    const botMsg = document.createElement("div");
    botMsg.className = "text-left bg-white shadow p-3 rounded-2xl max-w-[90%] ai-message";
    botMsg.innerHTML = responseHtml;
    chatMessages.appendChild(botMsg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  chatSend.onclick = sendMessage;
  chatInput.addEventListener("keypress", e => e.key === "Enter" && sendMessage());

  // Resize
  let isResizing = false;
  resizeHandle.addEventListener("mousedown", () => isResizing = true);
  document.addEventListener("mousemove", e => {
    if (!isResizing) return;
    let newWidth = e.clientX - chatContainer.getBoundingClientRect().left;
    let newHeight = e.clientY - chatContainer.getBoundingClientRect().top;
    if(newWidth > 250 && newWidth < window.innerWidth/2) chatContainer.style.width = newWidth + "px";
    if(newHeight > 300 && newHeight < window.innerHeight*0.9) chatContainer.style.height = newHeight + "px";
  });
  document.addEventListener("mouseup", () => isResizing = false);

  // Drag
  let isDragging = false, offsetX = 0, offsetY = 0;
  chatHeader.addEventListener("mousedown", e => {
    isDragging = true;
    const rect = chatContainer.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
  });
  document.addEventListener("mousemove", e => {
    if (!isDragging) return;
    chatContainer.style.position = "fixed";
    chatContainer.style.left = (e.clientX - offsetX) + "px";
    chatContainer.style.top = (e.clientY - offsetY) + "px";
    chatContainer.style.right = "auto";
    chatContainer.style.bottom = "auto";
  });
  document.addEventListener("mouseup", () => isDragging = false);
});
</script>

</body>
</html>
